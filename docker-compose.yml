version: '3.8'

services:
  # EVE LI Web Application (Production Mode)
  eve-li-web:
    build: .
    container_name: eve-li-web
    restart: unless-stopped
    
    # Port mapping for macOS (host mode doesn't work on Docker Desktop)
    ports:
      - "8502:8502"
    
    # Extra hosts to access local services
    extra_hosts:
      - "host.docker.internal:host-gateway"
    
    # Mount external data directories and config
    volumes:
      # Configuration file - SAME as local development (read-only)
      - ./.env:/app/.env:ro
      
      # Data directories (read-write)
      - ./logs:/app/logs
      - ./output:/app/output
      - ./.cache:/app/.cache
      - ./.flask_session:/app/.flask_session
    
    # All settings loaded from .env file (same as local development)
    # Override hosts to reach Mac host from container
    environment:
      # Bootstrap database credentials for ConfigManager
      - BOOTSTRAP_MYSQL_HOST=host.docker.internal
      - BOOTSTRAP_MYSQL_PORT=3306
      - BOOTSTRAP_MYSQL_USER=access
      - BOOTSTRAP_MYSQL_PASSWORD=44cC3sS
      - BOOTSTRAP_MYSQL_DATABASE=li_xml
      # DHCP database credentials for dhcp_database module
      - DB_HOST=host.docker.internal
      - DB_PORT=3306
      - DB_USER=access
      - DB_PASSWORD=44cC3sS
      - DB_DATABASE=access
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=8502
      # Point to Mac host for tunneled services
      - NETSHOT_API_URL=https://netshot.oss.local/api
      - MYSQL_HOST=host.docker.internal
      # Email configuration
      - EMAIL_ENABLED=true
      - SMTP_HOST=smtp.oss.local
      - SMTP_PORT=25
      - SMTP_USE_TLS=false
      - SMTP_USER=
      - SMTP_PASSWORD=
      - EMAIL_FROM=li-xml@appdb
      - EMAIL_FROM_NAME=VFZ Lawfull Intercept Generator
      - EMAIL_TO=silvester@vdleer.nl
      - WEB_URL=http://localhost:8080
      # Proxy configuration (use HTTP proxy for both HTTP and HTTPS)
      # Use host.docker.internal to reach the Mac host from the container
      - HTTP_PROXY=http://host.docker.internal:8080
      - HTTPS_PROXY=http://host.docker.internal:8080
      - http_proxy=http://host.docker.internal:8080
      - https_proxy=http://host.docker.internal:8080
      # Set timezone
      - TZ=Europe/Amsterdam
      # Bypass proxy for internal hosts
      - NO_PROXY=localhost,127.0.0.1,.oss.local,netshot.oss.local
      - no_proxy=localhost,127.0.0.1,.oss.local,netshot.oss.local
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # EVE LI Web Application (Demo Mode)
  # Same as production but with DEMO_MODE=true (no O365, MySQL, or Netshot needed)
  eve-li-web-demo:
    build: .
    container_name: eve-li-web-demo
    restart: unless-stopped
    network_mode: "host"
    
    volumes:
      - ./logs:/app/logs
      - ./output:/app/output
      - ./.flask_session:/app/.flask_session
    
    environment:
      # Demo Mode - No external services required
      - DEMO_MODE=true
      - FLASK_DEBUG=true
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=5000
      - FLASK_SECRET_KEY=demo-secret-key
      - APP_TITLE=EVE LI XML Generator - DEMO
    
    command: python web_app_demo.py
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    profiles:
      - demo

# Optional: Nginx Reverse Proxy for production with SSL
# Uncomment if you want to use Nginx in front of Flask
#  nginx:
#    image: nginx:alpine
#    container_name: eve-li-nginx
#    restart: unless-stopped
#    network_mode: "host"
#    volumes:
#      - ./nginx.conf:/etc/nginx/nginx.conf:ro
#      - ./ssl:/etc/nginx/ssl:ro

# Note: MySQL database runs on Docker host, not in container
# Ensure MySQL is accessible on localhost:3306 and localhost:3307

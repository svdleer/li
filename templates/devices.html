{% extends "base.html" %}

{% block title %}Devices - {{ app_title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="bi bi-router"></i> Devices</h2>
        <hr>
    </div>
</div>

<!-- Filter Tabs -->
<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <a class="nav-link {% if device_type == 'all' %}active{% endif %}" href="{{ url_for('devices', type='all') }}">All Devices</a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if device_type == 'cmts' %}active{% endif %}" href="{{ url_for('devices', type='cmts') }}">CMTS</a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if device_type == 'pe' %}active{% endif %}" href="{{ url_for('devices', type='pe') }}">PE</a>
    </li>
</ul>

<!-- Search Box -->
<div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="searchInput" placeholder="Search devices or IP addresses (e.g., 'pe-core' or '198.51.100' or '2a02:1')">
            <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                <i class="bi bi-x-circle"></i> Clear
            </button>
        </div>
        <small class="text-muted">Search by device name, type, or partial IP address (IPv4/IPv6)</small>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="text-center my-5" style="display:none;">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading devices...</span>
    </div>
    <p class="mt-3">Loading devices from Netshot and validating DHCP...</p>
</div>

<!-- Incomplete Devices Warning -->
{% if device_type in ['all', 'cmts'] and cmts_devices %}
{% set incomplete_devices = [] %}
{% for device in cmts_devices %}
    {% set has_issues = false %}
    {% set issues = [] %}
    
    {% if not device.loopback %}
        {% set _ = issues.append('No Loopback') %}
        {% set has_issues = true %}
    {% endif %}
    
    {% if not device.primary_subnet %}
        {% set _ = issues.append('No Primary Subnet') %}
        {% set has_issues = true %}
    {% endif %}
    
    {% if device.get('dhcp_validation') %}
        {% set dhcp_val = device.dhcp_validation %}
        {% if dhcp_val.missing_in_dhcp and dhcp_val.missing_in_dhcp|length > 0 %}
            {% set _ = issues.append('Missing in DHCP') %}
            {% set has_issues = true %}
        {% endif %}
    {% endif %}
    
    {% if has_issues %}
        {% set _ = device.update({'issues': issues}) %}
        {% set _ = incomplete_devices.append(device) %}
    {% endif %}
{% endfor %}

{% if incomplete_devices %}
<div class="alert alert-warning alert-permanent" role="alert">
    <strong><i class="bi bi-exclamation-triangle"></i> {{ incomplete_devices|length }} Incomplete Device(s)</strong>
    <button type="button" class="btn btn-sm btn-warning ms-2" data-bs-toggle="collapse" data-bs-target="#incompleteDevices">
        Show Details
    </button>
</div>

<div class="collapse mb-3" id="incompleteDevices">
    <div class="card border-warning">
        <div class="card-header bg-warning text-dark">
            <h6><i class="bi bi-exclamation-triangle"></i> Devices with Issues</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Device</th>
                            <th>Issues</th>
                            <th>Loopback</th>
                            <th>Primary</th>
                            <th>Public Subnets</th>
                            <th>DHCP Scopes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for device in incomplete_devices %}
                        <tr>
                            <td>
                                <strong>{{ device.oss10_hostname or device.name }}</strong>
                                {% if device.oss10_hostname %}<br><small class="text-muted">({{ device.name }})</small>{% endif %}
                            </td>
                            <td>
                                {% for issue in device.issues %}
                                    {% if issue == 'Missing in DHCP' %}
                                        <span class="badge bg-warning text-dark">{{ issue }}</span>
                                        {% if device.get('dhcp_validation', {}).get('missing_in_dhcp') %}
                                        <button class="btn btn-sm btn-outline-warning ms-1" type="button" 
                                                data-bs-toggle="collapse" 
                                                data-bs-target="#dhcp-missing-{{ device.name|replace('.', '-')|replace('_', '-') }}"
                                                title="Show missing subnets">
                                            <i class="bi bi-chevron-down"></i>
                                        </button>
                                        <div class="collapse mt-2" id="dhcp-missing-{{ device.name|replace('.', '-')|replace('_', '-') }}">
                                            <div class="card card-body bg-light">
                                                <small><strong>Missing in DHCP:</strong></small>
                                                <ul class="mb-0 small">
                                                {% for subnet in device.dhcp_validation.missing_in_dhcp %}
                                                    <li><code>{{ subnet }}</code></li>
                                                {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-warning text-dark">{{ issue }}</span>
                                    {% endif %}
                                {% endfor %}
                            </td>
                            <td>{{ device.loopback or '<span class="text-danger">Missing</span>'|safe }}</td>
                            <td>{{ device.primary_subnet or '<span class="text-danger">Missing</span>'|safe }}</td>
                            <td><span class="badge bg-info">{{ device.get('public_subnet_count', 0) }}</span></td>
                            <td><span class="badge bg-secondary">{{ device.get('dhcp_validation', {}).get('dhcp_scopes_count', 0) }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endif %}

<!-- CMTS Devices -->
{% if device_type in ['all', 'cmts'] and cmts_devices %}
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5><i class="bi bi-router"></i> CMTS Devices ({{ cmts_devices|length }})</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Management IP</th>
                        <th>Loopback</th>
                        <th>Primary Subnet</th>
                        <th>Public Subnets</th>
                        <th>DHCP Scopes</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in cmts_devices %}
                    {% set is_incomplete = device.name in incomplete_devices|map(attribute='name')|list or (device.oss10_hostname and device.oss10_hostname in incomplete_devices|map(attribute='oss10_hostname')|list) %}
                    <tr data-bs-toggle="collapse" data-bs-target="#cmts-{{ loop.index }}" 
                        style="cursor: pointer;" 
                        class="table-hover-row {% if is_incomplete %}table-warning{% endif %}">
                        <td>
                            {% if is_incomplete %}
                                <i class="bi bi-exclamation-triangle-fill text-warning"></i>
                            {% else %}
                                <i class="bi bi-chevron-right"></i>
                            {% endif %}
                            <strong>{{ device.oss10_hostname or device.name }}</strong>
                            {% if device.oss10_hostname %}<br><small class="text-muted">({{ device.name }})</small>{% endif %}
                            
                            {# Show issue count badge if incomplete #}
                            {% if is_incomplete %}
                                {% set issue_count = (incomplete_devices|selectattr('name', 'equalto', device.name)|first).issues|length if (incomplete_devices|selectattr('name', 'equalto', device.name)|first) else 0 %}
                                <span class="badge bg-warning text-dark ms-2" title="Device has {{ issue_count }} issue(s)">
                                    {{ issue_count }} issue{{ 's' if issue_count != 1 }}
                                </span>
                            {% endif %}
                        </td>
                        <td><span class="badge bg-primary">{{ device.device_type }}</span></td>
                        <td>{{ device.mgmtAddress.ip if device.mgmtAddress is mapping else device.mgmtAddress }}</td>
                        <td>
                            {% if device.loopback %}
                                <code>{{ device.loopback }}</code>
                            {% else %}
                                <span class="text-danger"><i class="bi bi-x-circle"></i> N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if device.primary_subnet %}
                                <code class="text-success">{{ device.primary_subnet }}</code>
                            {% else %}
                                <span class="text-danger"><i class="bi bi-x-circle"></i> Missing</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-info">{{ device.public_subnet_count|default(device.subnets|length) }}</span>
                        </td>
                        <td>
                            {% if device.dhcp_validation and device.dhcp_validation.has_dhcp %}
                                <span class="badge bg-success">{{ device.dhcp_validation.dhcp_scopes_count }}</span>
                                <small class="text-success ms-1"><i class="bi bi-check-circle-fill"></i> Validated</small>
                            {% elif device.dhcp_subnets %}
                                <span class="badge bg-warning">{{ device.dhcp_subnets|length }}</span>
                                <small class="text-warning ms-1"><i class="bi bi-exclamation-triangle"></i> Unvalidated</small>
                            {% else %}
                                <span class="badge bg-danger">0</span>
                                <small class="text-danger ms-1"><i class="bi bi-x-circle"></i> No DHCP</small>
                            {% endif %}
                        </td>
                        <td><span class="badge bg-success">{{ device.status }}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary refresh-device" 
                                    data-device="{{ device.name }}" 
                                    onclick="event.stopPropagation();"
                                    title="Refresh device data from Netshot & DHCP">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="9" class="p-0">
                            <div class="collapse" id="cmts-{{ loop.index }}">
                                <div class="card card-body m-2 bg-light">
                                    <h6><i class="bi bi-diagram-3"></i> Subnet Details for {{ device.oss10_hostname or device.name }}</h6>
                                    <p class="text-muted small">Vendor: {{ device.vendor }} | Type: {{ device.device_type }} | Software: {{ device.softwareVersion }}</p>
                                    
                                    <!-- Debug: {{ device.dhcp_validation }} -->
                                    {% if device.dhcp_validation %}
                                    <div class="mb-3">
                                        <h6 class="alert-heading"><i class="bi bi-database"></i> DHCP Database Validation</h6>
                                        <p class="text-muted small mb-2">
                                            <strong>Primary:</strong> <code>{{ device.primary_subnet or 'N/A' }}</code>
                                            {% if device.dhcp_validation.has_dhcp %}
                                            <span class="badge bg-success ms-2">✓ Found in DHCP ({{ device.dhcp_validation.dhcp_scopes_count }} public scopes)</span>
                                            {% else %}
                                            <span class="badge bg-warning ms-2">⚠ Not in DHCP</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-primary"><i class="bi bi-wifi"></i> IPv4 Subnets</h6>
                                            <ul class="list-group list-group-flush">
                                                {% for subnet in device.subnets %}
                                                {% if '.' in subnet and ':' not in subnet %}
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    <span><i class="bi bi-broadcast"></i> <code>{{ subnet }}</code></span>
                                                    <span>
                                                        {% if device.dhcp_validation and subnet in device.dhcp_validation.matched %}
                                                        <span class="badge bg-success">✓ In DHCP</span>
                                                        {% elif device.dhcp_validation and subnet in device.dhcp_validation.missing_in_dhcp %}
                                                        <span class="badge bg-warning text-dark">⚠ Not in DHCP</span>
                                                        {% endif %}
                                                    </span>
                                                </li>
                                                {% endif %}
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-info"><i class="bi bi-globe"></i> IPv6 Subnets</h6>
                                            <ul class="list-group list-group-flush">
                                                {% for subnet in device.subnets %}
                                                {% if ':' in subnet %}
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    <span><i class="bi bi-globe"></i> <code>{{ subnet }}</code></span>
                                                    <span>
                                                        {% if device.dhcp_validation and subnet in device.dhcp_validation.ipv6_matched %}
                                                        <span class="badge bg-success">✓ In DHCP</span>
                                                        {% elif device.dhcp_validation and subnet in device.dhcp_validation.ipv6_missing_in_dhcp %}
                                                        <span class="badge bg-warning text-dark">⚠ Not in DHCP</span>
                                                        {% endif %}
                                                    </span>
                                                </li>
                                                {% endif %}
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- PE Devices -->
{% if device_type in ['all', 'pe'] and pe_devices %}
<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <h5><i class="bi bi-diagram-3"></i> PE Devices ({{ pe_devices|length }})</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Management IP</th>
                        <th>Loopback</th>
                        <th>Subnets</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in pe_devices %}
                    <tr data-bs-toggle="collapse" data-bs-target="#pe-{{ loop.index }}" style="cursor: pointer;" class="table-hover-row">
                        <td>
                            <strong><i class="bi bi-chevron-right"></i> {{ device.oss10_hostname or device.name }}</strong>
                            {% if device.oss10_hostname %}<br><small class="text-muted">({{ device.name }})</small>{% endif %}
                        </td>
                        <td><span class="badge bg-success">{{ device.device_type }}</span></td>
                        <td>{{ device.mgmtAddress.ip if device.mgmtAddress is mapping else device.mgmtAddress }}</td>
                        <td><code>{{ device.loopback or 'N/A' }}</code></td>
                        <td><span class="badge bg-info">{{ device.subnets|length }} total</span></td>
                        <td><span class="badge bg-success">{{ device.status }}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary refresh-device" 
                                    data-device="{{ device.name }}" 
                                    onclick="event.stopPropagation();"
                                    title="Refresh device data from Netshot & DHCP">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="7" class="p-0">
                            <div class="collapse" id="pe-{{ loop.index }}">
                                <div class="card card-body m-2 bg-light">
                                    <h6><i class="bi bi-diagram-3"></i> Subnet Details for {{ device.oss10_hostname or device.name }}</h6>
                                    <p class="text-muted small">Vendor: {{ device.vendor }} | Type: {{ device.device_type }} | Software: {{ device.softwareVersion }}</p>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-primary"><i class="bi bi-diagram-2"></i> IPv4 Subnets</h6>
                                            <ul class="list-group list-group-flush">
                                                {% for subnet in device.subnets %}
                                                {% if '.' in subnet and ':' not in subnet %}
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    <span><i class="bi bi-diagram-2"></i> <code>{{ subnet }}</code></span>
                                                    <span>
                                                        <span class="badge bg-success">IPv4 Subnet</span>
                                                    </span>
                                                </li>
                                                {% endif %}
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-info"><i class="bi bi-globe"></i> IPv6 Subnets</h6>
                                            <ul class="list-group list-group-flush">
                                                {% for subnet in device.subnets %}
                                                {% if ':' in subnet %}
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    <span><i class="bi bi-globe"></i> <code>{{ subnet }}</code></span>
                                                    <span>
                                                        <span class="badge bg-info">IPv6 Subnet</span>
                                                    </span>
                                                </li>
                                                {% endif %}
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

{% if not cmts_devices and not pe_devices %}
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i> No devices found. Check your Netshot connection.
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
// Search functionality
const searchInput = document.getElementById('searchInput');
if (searchInput) {
    searchInput.addEventListener('keyup', function() {
        const searchTerm = this.value.toLowerCase().trim();
        filterDevices(searchTerm);
    });
}

function filterDevices(searchTerm) {
    // Get all device rows (both CMTS and PE) - only the clickable rows, not the collapse details
    const cmtsRows = document.querySelectorAll('.card-body .table-hover tbody tr[data-bs-toggle="collapse"]');
    const peRows = document.querySelectorAll('.card-body .table-hover tbody tr[data-bs-toggle="collapse"]');
    const allRows = [...cmtsRows, ...peRows];
    
    let visibleCount = 0;
    
    allRows.forEach(row => {
        if (!searchTerm) {
            row.style.display = '';
            visibleCount++;
            return;
        }
        
        // Get device name
        const deviceName = row.querySelector('td:first-child strong')?.textContent.toLowerCase() || '';
        
        // Get device type
        const deviceType = row.querySelector('.badge')?.textContent.toLowerCase() || '';
        
        // Get all subnet information from the collapsed row
        const rowIndex = row.dataset.bsTarget;
        let subnets = '';
        if (rowIndex) {
            const collapsedRow = document.querySelector(rowIndex);
            if (collapsedRow) {
                const subnetCodes = collapsedRow.querySelectorAll('code');
                subnetCodes.forEach(code => {
                    subnets += code.textContent.toLowerCase() + ' ';
                });
            }
        }
        
        // Check if search term matches device name, type, or any subnet
        const matches = deviceName.includes(searchTerm) || 
                       deviceType.includes(searchTerm) ||
                       subnets.includes(searchTerm);
        
        if (matches) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update cards visibility if no devices match
    updateCardVisibility();
}

function updateCardVisibility() {
    const cmtsCard = document.querySelector('.card.mb-4');
    const peCard = document.querySelectorAll('.card.mb-4')[1];
    
    if (cmtsCard) {
        const visibleCmts = Array.from(cmtsCard.querySelectorAll('tbody tr:not(.collapse)'))
            .filter(row => row.style.display !== 'none').length;
        cmtsCard.style.display = visibleCmts > 0 ? '' : 'none';
    }
    
    if (peCard) {
        const visiblePe = Array.from(peCard.querySelectorAll('tbody tr:not(.collapse)'))
            .filter(row => row.style.display !== 'none').length;
        peCard.style.display = visiblePe > 0 ? '' : 'none';
    }
}

function clearSearch() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.value = '';
        filterDevices('');
    }
}

// Since we're using server-side rendering, just hide the spinner when page is ready
document.addEventListener('DOMContentLoaded', function() {
    // Hide spinner if we have content already rendered
    const cmtsDevices = {{ cmts_devices|length }};
    const peDevices = {{ pe_devices|length }};
    
    if (cmtsDevices > 0 || peDevices > 0) {
        const spinner = document.getElementById('loadingSpinner');
        if (spinner) spinner.style.display = 'none';
    } else {
        // No devices, hide spinner and show message
        const spinner = document.getElementById('loadingSpinner');
        if (spinner) spinner.style.display = 'none';
    }
});

// Handle device refresh button clicks
document.querySelectorAll('.refresh-device').forEach(button => {
    button.addEventListener('click', function(e) {
        e.stopPropagation();  // Prevent row collapse toggle
        const deviceName = this.getAttribute('data-device');
        const icon = this.querySelector('i');
        
        // Add spinning animation
        icon.classList.add('fa-spin');
        this.disabled = true;
        
        // Show page-level loading indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'refresh-loading-overlay';
        loadingDiv.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center';
        loadingDiv.style.backgroundColor = 'rgba(0,0,0,0.5)';
        loadingDiv.style.zIndex = '9999';
        loadingDiv.innerHTML = `
            <div class="card text-center p-4 shadow-lg">
                <div class="card-body">
                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Refreshing...</span>
                    </div>
                    <h5>Refreshing Device Data</h5>
                    <p class="text-muted mb-0">Please wait while we fetch the latest data from Netshot and DHCP...</p>
                    <small class="text-muted">Device: ${deviceName}</small>
                </div>
            </div>
        `;
        document.body.appendChild(loadingDiv);
        
        // Call refresh endpoint
        fetch(`devices/refresh/${deviceName}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('refresh-loading-overlay')?.remove();
            if (data.success) {
                // Show success message and reload page
                alert(`✓ Cache cleared for ${deviceName}. Page will reload.`);
                window.location.reload();
            } else {
                alert(`Error: ${data.error}`);
                icon.classList.remove('fa-spin');
                this.disabled = false;
            }
        })
        .catch(error => {
            document.getElementById('refresh-loading-overlay')?.remove();
            alert(`Error refreshing device: ${error}`);
            icon.classList.remove('fa-spin');
            this.disabled = false;
        });
    });
});

// Add chevron rotation on collapse
document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(element => {
    element.addEventListener('click', function() {
        const icon = this.querySelector('.bi-chevron-right');
        if (icon) {
            icon.classList.toggle('bi-chevron-right');
            icon.classList.toggle('bi-chevron-down');
        }
    });
});
</script>
{% endblock %}
